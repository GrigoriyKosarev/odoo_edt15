# ============================================
# Docker Compose для Odoo 15
# ============================================
#
# Що таке Docker Compose?
# -----------------------
# Інструмент для запуску кількох контейнерів разом.
# Замість писати довгі docker run команди - описуємо все в YAML файлі.
#
# Як використовувати:
# -------------------
# cd docker/odoo15
# docker compose up -d        # Запустити у фоні
# docker compose down         # Зупинити
# docker compose logs -f      # Дивитися логи
# docker compose ps           # Статус контейнерів
#

# ============================================
# version - версія формату Docker Compose
# ============================================
# Можна не вказувати в нових версіях Docker
# version: '3.8'

# ============================================
# services - список сервісів (контейнерів)
# ============================================
services:

  # ==========================================
  # Сервіс: PostgreSQL (база даних)
  # ==========================================
  db15:
    # image - який образ використовувати
    # Формат: назва:тег (тег = версія)
    # Береться з Docker Hub: https://hub.docker.com/_/postgres
    image: postgres:14

    # container_name - ім'я контейнера
    # Без цього Docker згенерує випадкове ім'я
    container_name: odoo15_db

    # environment - змінні середовища
    # PostgreSQL читає ці змінні при першому запуску
    environment:
      # Користувач БД (буде створений автоматично)
      - POSTGRES_USER=odoo
      # Пароль користувача
      - POSTGRES_PASSWORD=odoo
      # База даних за замовчуванням
      - POSTGRES_DB=postgres
      # Де зберігати дані всередині контейнера
      - PGDATA=/var/lib/postgresql/data/pgdata

    # volumes - монтування папок
    # Формат: <шлях_на_хості>:<шлях_в_контейнері>
    # Дані БД зберігаються на хості, щоб не зникли при видаленні контейнера
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

    # ports - прокидання портів
    # Формат: "<порт_хоста>:<порт_контейнера>"
    # 5433 на хості → 5432 в контейнері
    # Чому 5433? Щоб не конфліктувати з локальним PostgreSQL (5432)
    ports:
      - "5433:5432"

    # restart - політика перезапуску
    # unless-stopped - перезапускати завжди, крім ручної зупинки
    restart: unless-stopped

  # ==========================================
  # Сервіс: Odoo 15
  # ==========================================
  odoo15:
    # build - збірка образу з Dockerfile
    # Замість image: odoo:15 - будуємо власний образ
    build:
      # context - папка з Dockerfile
      context: .
      # dockerfile - ім'я файлу (за замовчуванням Dockerfile)
      dockerfile: Dockerfile

    # image - ім'я для зібраного образу
    # Без цього буде автоматична назва
    image: my-odoo:15

    container_name: odoo15

    # depends_on - залежності
    # Odoo запуститься ПІСЛЯ db15
    # Але не гарантує що БД готова приймати з'єднання!
    depends_on:
      - db15

    # environment - змінні для Odoo
    # Odoo може читати налаштування з змінних середовища
    environment:
      # Ці значення перевизначать odoo.conf якщо вказані
      - HOST=db15
      - USER=odoo
      - PASSWORD=odoo

    # volumes - монтування папок
    volumes:
      # Ваші модулі: папка проекту → /mnt/extra-addons
      # ../.. означає "на два рівні вгору" (до кореня проекту)
      - ../../:/mnt/extra-addons

      # Дані Odoo (filestore - завантажені файли)
      - ./data/odoo:/var/lib/odoo

    # ports - порти
    # 8069 - веб-інтерфейс
    # 8072 - longpolling (live chat, нотифікації)
    ports:
      - "8069:8069"
      - "8072:8072"

    restart: unless-stopped

# ============================================
# networks - мережі (опціонально)
# ============================================
# За замовчуванням Docker створює мережу для compose
# Контейнери бачать один одного по імені сервісу
# (odoo15 бачить db15 по імені "db15")
networks:
  default:
    name: odoo15_network
